# 计算机系统要素：从零开始构建现代计算机

---

# 第九章：高级语言High-Level language

#### 将介绍一门高级语言，名为Jack，简单的基于对象object-based的语言

每种编程语言都有一组固定的基本数据类型，Jack支持三种基本数据类型：int、char和boolean。程序员可以通过创建新的抽象数据类型对基本数据类型进行扩展。

#### 定义类的接口

合理的方法是，指定该分数抽象中的属性和服务。
**应用程序接口API Application Program Interface**

在当前对象上的操作用**方法methods**来表示，在类级别上的操作用**函数functions**来表示。创建新对象的操作称为**构造函数constructor**

---

用户只能访问到该抽象的**接口interface**或称API，并将其看作提供“与抽象相关的操作”的黑匣子

---

#### 链表linked list，或简称列表，list

是一种对象链，每个对象包含数据域和指向链表中另一个对象的指针

---

# Jack语言规范详述The Jack Language Specification

现在来对Jack语言作正式完整的描述，包括语法要素、程序结构、变量、表达式和语句构成。必要时该语言规范可被看作是技术参考

---

#### 语法要素Syntactic Elements

Jack程序是一系列用任意数量空格和注释而分隔开来的**字元tokens**，这些字元可以是**符号symbol**，**保留字reserved words**，**常数constants**和**标识符identifiers**

---

#### 程序结构Program Structure

Jack中的基本编程单元是**类class**。每个类存在于独立的文件中，可独立编译。每个类声明先指定类的名称，通过该名称，对应的类可以在全局范围内被访问到。接下来是一组零个或多个成员**字段field**和**静态变量static variable**声明。最后是一组一个或多个**子程序subroutine**声明，每个声明定义**方法**、**函数**或**构造函数**。方法“属于”对象并且提供对象的功能；函数一般“属于”类，而且不与某个特定的对象相；构造函数“属于”类，在被调用时生成该类的对象实例

---

#### 变量Variables

Jack语言中的变量在使用之前必须先被显式地声明出来。在Jack中有四种类型的变量：成员字段field，静态变量static variable，局部变量local variable和参数变量parameter，每种变量都有其适用范围

**数据类型**：变量可以是一种**基本数据类型(int/char/boolean)**，或者**对象类型(object type)**，即类名称

**基本类型**：int、boolean、char
当基本类型变量被声明时，就会在内存中为其分配对应的内存单元

**对象类型object types**：每个类定义了对象类型。对象的声明实际只是创建一个指向该对象的引用变量（指针），真正用于存储该对象的内存单元只有在调用构造函数来构造对象时才会被分配

Jack标准程序库提供了两个内置对象类型（类）：Array和String

**数组Array**：使用内置类Array来声明
**字符串Strings**：使用内置类String来声明，Jack编译器能够认出“xxx”并且将其当作是某个String对象的内容
**类型转换**：Jack是**弱类型weakly typed**语言。语言规范并没有定义从一种类型转为另一种类型的结果，允许或禁止某种转换是根据不同的编译器而定的

所有的Jack编译器都期望能允许并且自动执行下面的任务

+ 字符和整数能够根据Unicode规范在必要时相互转换
+ 整数可被赋给任何对象类型的**引用变量reference variable**，这时该整数被当作是内存中的地址
+ 对象变量（其类型为某个类）可被转换成Array变量，反之亦然，经过转换就可以像访问数组中的数据项一样去访问对象中的成员，反之亦然
  **没太懂**

**变量的类型和作用域**：**静态变量static variable**定义在类这一级，被该类的所有对象共享。**成员字段变量field variable**用于定义类对象的**属性properties**；**局部变量local variable**，被子程序使用，仅仅存在于子程序的生存周期内；**参数变量parameter variable**用于传递变量给子程序。

---

#### 语句Statements

let if while do return

---

#### 表达式Expressions

Jack表达式必须是下列之一

+ 常数
+ 在作用域内的变量名（变量可以是静态、局部、成员或参数类型）
+ 关键字this，引用当前对象（不能用于函数中）
+ 数组语法是：数组名称[表达式]，其中数组名称是Array类型的变量名
+ 返回值为非空non-void类型的**子程序调用subroutine call**
+ 一元运算符“-”或“~”作前缀的表达式：-：算术求反；~：布尔求反（对于整数，则按位取反）
+ 形如：表达式 运算符 表达式 的表达式，其中运算符operator是以下二元运算符中的一种：+-*/ $| <>=
+ (表达式)：位于圆括号内的表达式

**运算符优先级和计算顺序**：除了规定括号中的表达式要先计算外，Jack语言中没有定义运算符的优先级，简化Jack编译器的编写

---

#### 子程序调用Subroutine Calls

子程序调用唤起方法method、函数function、构造函数constructor，使用这样的语法形式：*methodName(argumentlist)*

#### 对象构造Construction和清楚Disposal

对象的构造可以分为两个阶段。在程序定义某个对象类型的变量之后，仅仅创建了引用（指针）变量**并为其分配了内存？？？（不懂）**。为了完成对象的构造，程序必须调用该类的构造函数

例如，let c =Circle.new(x, y, 50)这里x、y和50是圆心在屏幕上的位置和圆的半径。调用构造函数时，编译器会要求操作系统分配足够的内存空间（实际就是一块内存段）来存放新对象。操作系统会返回该内存段的基地址，最后编译器将该地址赋予this指针（在Circle例子中，this的值被赋给c）。接下来，对象将被初始化，具体由构造函数中的Jack语句来完成

当程序中不再需要某个对象时，该对象就可以被清楚。特别需要指出的是，对象可以从内存中去配空间，可以通过使用标准库中的Memory.deAlloc(object)函数收回原先分配给对象的内存空间。按照惯例，每个类都要包含dispose()方法，用来封装去配操作

---

#### Jack标准库The Jack Standard Library

Jack语言本身提供了一组内置类，扩展了语言能力。该标准库也可以被看作是基本的操作系统，必须提供给Jack语言实现

---

#### 应用程序的设计和实现

在Hack这样的硬件平台上开发Jack应用程序需要进行仔细规划。首先，应用程序设计者必须考虑硬件的物理限制，然后进行相应的计划。同样地，为了斟酌具体能做什么和不能做什么，设计者必须考虑语言的输入/输出命令的适用范围和平台的执行速度

通常，在设计流程中，首先要对应用程序的行为作概念性描述。在图形和交互式程序的情况下，该描述通常表现为屏幕画面的手绘图例，在一些简单应用中，设计者可以从过程化编程来开始逐步实现，在更复杂的应用中，建议首先为应用程序创建基于对象的设计方案

接下来，设计者可以用Jack语言来实现设计，使用Jack编译器来编译类文件

#### Jack OS

Jack程序会大量使用语言自身的标准库（也称为Jack OS）提供的各种抽象和服务，OS本身也是用Jack语言编写的，因此其可执行版本也是一组编译后的.vm文件，与编译之后的用户程序是类似的。因此，在运行任何Jack程序之前，首先必须将包含Jack OS的.vm文件拷贝到程序路径下

计算机首先运行Sys.init，该函数会自动运行Main.main函数，接着Main.main函数将从用户程序和OS中调用各种子程序和服务